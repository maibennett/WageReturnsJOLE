------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
      name:  <unnamed>
       log:  [REDACTED]y97/Geocode/y97_create_geocode.log
  log type:  text
 opened on:   8 Feb 2019, 09:50:18

. 
. *****************************************************************************
. * Merge geocode into the monthly data with interview month
. *  and impute location for time between interviews
. *****************************************************************************
. *============================================================================
. * Impute location according to the following rules:
. *  (1) If someone switches location between consecutive interviews,
. *    - assume i is in the new location the month after interview_{t}
. *      (as opposed to the month before interview_{t+1}
. *  (2) If someone switches location sometime in a missing interview spell,
. *    - assume i is in the new location the month after interview_{t}
. *      (as opposed to the month before interview_{t+1}
. *============================================================================
. *----------------------------------------------------------------------------
. * Before the merge, backfill gaps in missed interviews. Doing this before
. *  the merge is needed because of the way observations are dropped.
. *----------------------------------------------------------------------------
. use y97_geocode_raw.dta, clear

. preserve

.     * fix problem that arises from misalignment of interview year and survey year
.     * fix it by copying the last survey year
.     tempfile holderExpand

.     keep if year==2015
(170,696 observations deleted)

.     replace year = 2016
(8,984 real changes made)

.     sort id year

.     save `holderExpand'
file /tmp/St31654.000002 saved

. restore

. merge 1:1 id year using `holderExpand', nogen
(label vlfips_quality already defined)
(label vlfips_msa_type already defined)
(label vlmigim already defined)
(label vlmigqu already defined)
(label vlmigst already defined)

    Result                           # of obs.
    -----------------------------------------
    not matched                       170,696
        from master                   170,696  
        from using                          0  

    matched                             8,984  
    -----------------------------------------

. 
. gen fips_co_old = fips_co
(49,395 missing values generated)

. gen fips_st_old = fips_st
(49,233 missing values generated)

. 
. * If fips_st==0, replace fips_st and fips_co with 0.
. *  Note: we can use state mean for fips_co==0 with valid fips_st
. replace fips_co = .o if fips_st==0
(0 real changes made)

. replace fips_st = .o if fips_st==0
(0 real changes made)

. 
. 
. * Sort descending and backfill non-missing values
. gsort id -year

. by id: replace fips_co = fips_co[_n-1] if mi(fips_co) & !mi(fips_co[_n-1]) & _n>1
(25,750 real changes made)

. by id: replace fips_st = fips_st[_n-1] if mi(fips_st) & !mi(fips_st[_n-1]) & _n>1
(25,638 real changes made)

. 
. * Sort ascending and fill missing values with last observed county
. sort id year

. by id: replace fips_co = fips_co[_n-1] if mi(fips_co) & !mi(fips_co[_n-1]) & _n>1
(23,645 real changes made)

. by id: replace fips_st = fips_st[_n-1] if mi(fips_st) & !mi(fips_st[_n-1]) & _n>1
(23,595 real changes made)

. 
. keep id year fips_st fips_co unemp

. compress
  (0 bytes saved)

. tempfile holder1

. save `holder1'
file /tmp/St31654.000003 saved

. 
. !unzip -u ../y97_all.dta.zip


. use id year month birthYear R14* R15* R16* R17* Interview_date missInt using y97_all.dta, clear

. !rm y97_all.dta


. replace Interview_date = R17interviewDate if year==2016 & mi(Interview_date)
(2,567 real changes made)

. sort id year

. 
. isid id year month

. merge m:1 id year using `holder1'

    Result                           # of obs.
    -----------------------------------------
    not matched                       207,395
        from master                   172,824  (_merge==1)
        from using                     34,571  (_merge==2)

    matched                         1,710,637  (_merge==3)
    -----------------------------------------

. * assert _merge!=1
. drop if _merge==2 
(34,571 observations deleted)

. drop _merge

. 
. *============================================================================
. * Impute monthly counties
. *============================================================================
. generat intThisMonth = month(Interview_date)==month & year(dofm(Interview_date))==year

. * replace intThisMonth = 1 if month(R17interviewDay)==month & year(R17interviewDay)==2016 & year==2016
. *l id year month fips* intThisMonth  R17interview* if id==65 & inrange(year,2015,2016)
. 
. gsort id -year -month

.     by id: gen     fips_co2 = fips_co        if intThisMonth  | _n==1
(1,793,715 missing values generated)

.     by id: replace fips_co2 = fips_co2[_n-1] if !intThisMonth & _n> 1
(1,793,715 real changes made)

.     by id: replace fips_co2 = fips_co2[_n-1] if mi(fips_co2)  & _n> 1
(0 real changes made)

.     
.     by id: gen     fips_st2 = fips_st        if intThisMonth  | _n==1
(1,793,715 missing values generated)

.     by id: replace fips_st2 = fips_st2[_n-1] if !intThisMonth & _n> 1
(1,793,715 real changes made)

.     by id: replace fips_st2 = fips_st2[_n-1] if mi(fips_st2)  & _n> 1
(0 real changes made)

. sort id year month

. 
. * recode fips* (-4 = .v)
. 
. order id year month missInt Interview_date intThisMonth fips_st fips_co fips_st2 fips_co2 

. save y97_geocode2, replace
file y97_geocode2.dta saved

. 
. *============================================================================
. * Merge in county characteristics (empPct and incPerCapita; final versions)
. *============================================================================
. drop fips_st fips_co

. rename fips_st2    fips_st

. rename fips_co2    fips_co

. 
. * Hand edits
. replace fips_co=86 if fips_st==12 & fips_co==25 // For example when Dade County, Florida (FIPS code 12025) became Miami-Dade County in 1997, it received the new FIPS code of 12086, http://coweeta.uga.edu/trends/datadictionary/fipscode.html
(0 real changes made)

. 
. tab year

    Year of |
     Survey |      Freq.     Percent        Cum.
------------+-----------------------------------
       1993 |     10,782        0.57        0.57
       1994 |     31,895        1.69        2.27
       1995 |     54,194        2.88        5.14
       1996 |     75,953        4.03        9.18
       1997 |     95,240        5.06       14.23
       1998 |    103,653        5.50       19.74
       1999 |    101,745        5.40       25.14
       2000 |     99,888        5.30       30.44
       2001 |     97,898        5.20       35.64
       2002 |     96,079        5.10       40.74
       2003 |     93,866        4.98       45.72
       2004 |     91,753        4.87       50.60
       2005 |     89,791        4.77       55.36
       2006 |     88,598        4.70       60.07
       2007 |     87,138        4.63       64.69
       2008 |     86,126        4.57       69.27
       2009 |     85,095        4.52       73.78
       2010 |     85,060        4.52       78.30
       2011 |     84,958        4.51       82.81
       2012 |     84,852        4.51       87.32
       2013 |     84,827        4.50       91.82
       2014 |     84,773        4.50       96.32
       2015 |     66,730        3.54       99.86
       2016 |      2,567        0.14      100.00
------------+-----------------------------------
      Total |  1,883,461      100.00

. merge m:1 fips_st fips_co year using ../../county_data, keepusing(year fips_st fips_co AreaName cbsa incPerCapitaFinal incPerCapita empPctFinal empPct empTot empTotMSA)

    Result                           # of obs.
    -----------------------------------------
    not matched                       132,421
        from master                       342  (_merge==1)
        from using                    132,079  (_merge==2)

    matched                         1,883,119  (_merge==3)
    -----------------------------------------

. 
. gen m_empPct       = mi(empPctFinal)

. gen m_incPerCapita = mi(incPerCapitaFinal)

. 
. replace fips_co = -99 if m_empPct | m_incPerCapita
(2,277 real changes made)

. replace fips_st = -99 if (m_empPct | m_incPerCapita) & (fips_st==0 | fips_st>56)
(0 real changes made)

. 
. drop if _merge==2
(132,079 observations deleted)

. drop AreaName-_merge

. 
. tab year

    Year of |
     Survey |      Freq.     Percent        Cum.
------------+-----------------------------------
       1993 |     10,782        0.57        0.57
       1994 |     31,895        1.69        2.27
       1995 |     54,194        2.88        5.14
       1996 |     75,953        4.03        9.18
       1997 |     95,240        5.06       14.23
       1998 |    103,653        5.50       19.74
       1999 |    101,745        5.40       25.14
       2000 |     99,888        5.30       30.44
       2001 |     97,898        5.20       35.64
       2002 |     96,079        5.10       40.74
       2003 |     93,866        4.98       45.72
       2004 |     91,753        4.87       50.60
       2005 |     89,791        4.77       55.36
       2006 |     88,598        4.70       60.07
       2007 |     87,138        4.63       64.69
       2008 |     86,126        4.57       69.27
       2009 |     85,095        4.52       73.78
       2010 |     85,060        4.52       78.30
       2011 |     84,958        4.51       82.81
       2012 |     84,852        4.51       87.32
       2013 |     84,827        4.50       91.82
       2014 |     84,773        4.50       96.32
       2015 |     66,730        3.54       99.86
       2016 |      2,567        0.14      100.00
------------+-----------------------------------
      Total |  1,883,461      100.00

. merge m:1 fips_st fips_co year using ../../county_data, keepusing(year fips_st fips_co AreaName cbsa incPerCapitaFinal incPerCapita empPctFinal empPct empTot empTotMSA)

    Result                           # of obs.
    -----------------------------------------
    not matched                       132,055
        from master                         0  (_merge==1)
        from using                    132,055  (_merge==2)

    matched                         1,883,461  (_merge==3)
    -----------------------------------------

. * assert _merge!=1
. drop if _merge==2
(132,055 observations deleted)

. drop _merge

. 
. *============================================================================
. * Merge in monthly unemployment rate from BLS (not NLSY-provided rate)
. *============================================================================
. tempfile county_unemp

. preserve

.     use ../../county_unemp_monthly, clear

.     ren state fips_st

.     ren county fips_co

.     save `county_unemp', replace
(note: file /tmp/St31654.000004 not found)
file /tmp/St31654.000004 saved

. restore

. 
. merge m:1 fips_st fips_co year month using `county_unemp', keepusing(urate)

    Result                           # of obs.
    -----------------------------------------
    not matched                       863,157
        from master                       393  (_merge==1)
        from using                    862,764  (_merge==2)

    matched                         1,883,068  (_merge==3)
    -----------------------------------------

. drop if _merge==2
(862,764 observations deleted)

. drop _merge

. 
. * rename empPctFinal       empPct
. * rename incPerCapitaFinal incPerCapita
. 
. *============================================================================
. * Merge in IPEDS data on number of colleges in county, etc.
. *============================================================================
. * year            int     %9.0g                 year
. * fips5           float   %9.0g
. * numBA           long    %9.0g                 (count) BAplus
. * numAA           long    %9.0g                 (count) AAonly
. * tuitionBApublic float   %9.0g                 (mean) publicTuition2BA
. * tuitionBApriv~e float   %9.0g                 (mean) privateTuition2BA
. * tuitionAApublic float   %9.0g                 (mean) publicTuition2AA
. * tuitionAApriv~e float   %9.0g                 (mean) privateTuition2AA
. 
. tempfile ipeds

. preserve

.     use ../../ipeds_final, clear
(IPEDS Interim Data - UNITID Year)

.     keep if year==2005
(47,139 observations deleted)

.     drop year

.     gen fips_st16 = floor(fips5/1000)
(1 missing value generated)

.     gen fips_co16 = fips5 - 1000*fips_st
(1 missing value generated)

.     l fips5 fips_st fips_co in 1/50, sep(0)

     +-----------------------------+
     | fips5   fips_s~6   fips_c~6 |
     |-----------------------------|
  1. |  1001          1          1 |
  2. |  1003          1          3 |
  3. |  1007          1          7 |
  4. |  1009          1          9 |
  5. |  1015          1         15 |
  6. |  1017          1         17 |
  7. |  1027          1         27 |
  8. |  1031          1         31 |
  9. |  1033          1         33 |
 10. |  1035          1         35 |
 11. |  1043          1         43 |
 12. |  1045          1         45 |
 13. |  1047          1         47 |
 14. |  1049          1         49 |
 15. |  1053          1         53 |
 16. |  1055          1         55 |
 17. |  1065          1         65 |
 18. |  1069          1         69 |
 19. |  1071          1         71 |
 20. |  1073          1         73 |
 21. |  1077          1         77 |
 22. |  1081          1         81 |
 23. |  1083          1         83 |
 24. |  1087          1         87 |
 25. |  1089          1         89 |
 26. |  1097          1         97 |
 27. |  1099          1         99 |
 28. |  1101          1        101 |
 29. |  1117          1        117 |
 30. |  1119          1        119 |
 31. |  1125          1        125 |
 32. |  2020          2         20 |
 33. |  2090          2         90 |
 34. |  2110          2        110 |
 35. |  2122          2        122 |
 36. |  2185          2        185 |
 37. |  2220          2        220 |
 38. |  2261          2        261 |
 39. |  4001          4          1 |
 40. |  4003          4          3 |
 41. |  4005          4          5 |
 42. |  4009          4          9 |
 43. |  4013          4         13 |
 44. |  4015          4         15 |
 45. |  4017          4         17 |
 46. |  4019          4         19 |
 47. |  4025          4         25 |
 48. |  4027          4         27 |
 49. |  5001          5          1 |
 50. |  5005          5          5 |
     +-----------------------------+

.     save `ipeds', replace
(note: file /tmp/St31654.000006 not found)
file /tmp/St31654.000006 saved

. restore

. 
. gen year16 = birthYear+16

. bys id: gen fips_stA = fips_st if year==year16 & month==9
(1,874,807 missing values generated)

. bys id: gen fips_coA = fips_co if year==year16 & month==9
(1,874,807 missing values generated)

. bys id: egen fips_st16 = max(fips_stA)
(5222 missing values generated)

. bys id: egen fips_co16 = max(fips_coA)
(5222 missing values generated)

. merge m:1 fips_st16 fips_co16 using `ipeds', keep(master match) keepusing(numBA numAA tuition*)

    Result                           # of obs.
    -----------------------------------------
    not matched                       290,370
        from master                   290,370  (_merge==1)
        from using                          0  (_merge==2)

    matched                         1,593,091  (_merge==3)
    -----------------------------------------

. drop if _merge==2
(0 observations deleted)

. drop _merge

. 
. mdesc numBA numAA tuition*
     Variable      Missing      Total     Missing/Total
    ------------------------------------------------------------
       numBA      290370     1.9e+06        .154168
       numAA      290370     1.9e+06        .154168
tuitionBAp~c      471351     1.9e+06        .250258
tuitionBAp~e      679929     1.9e+06           .361
tuitionAAp~c     1.8e+06     1.9e+06           .951
tuitionAAp~e     1.4e+06     1.9e+06        .735934

. 
. tab year

    Year of |
     Survey |      Freq.     Percent        Cum.
------------+-----------------------------------
       1993 |     10,782        0.57        0.57
       1994 |     31,895        1.69        2.27
       1995 |     54,194        2.88        5.14
       1996 |     75,953        4.03        9.18
       1997 |     95,240        5.06       14.23
       1998 |    103,653        5.50       19.74
       1999 |    101,745        5.40       25.14
       2000 |     99,888        5.30       30.44
       2001 |     97,898        5.20       35.64
       2002 |     96,079        5.10       40.74
       2003 |     93,866        4.98       45.72
       2004 |     91,753        4.87       50.60
       2005 |     89,791        4.77       55.36
       2006 |     88,598        4.70       60.07
       2007 |     87,138        4.63       64.69
       2008 |     86,126        4.57       69.27
       2009 |     85,095        4.52       73.78
       2010 |     85,060        4.52       78.30
       2011 |     84,958        4.51       82.81
       2012 |     84,852        4.51       87.32
       2013 |     84,827        4.50       91.82
       2014 |     84,773        4.50       96.32
       2015 |     66,730        3.54       99.86
       2016 |      2,567        0.14      100.00
------------+-----------------------------------
      Total |  1,883,461      100.00

. save y97_geocode3, replace
file y97_geocode3.dta saved

. ! chmod 774 *.dta


. !zip -m y97_geocode3.dta.zip y97_geocode3.dta


. 
. log close
      name:  <unnamed>
       log:  [REDACTED]y97/Geocode/y97_create_geocode.log
  log type:  text
 closed on:   8 Feb 2019, 09:51:03
------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
